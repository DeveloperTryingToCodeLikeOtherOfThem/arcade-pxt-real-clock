namespace countdown {
    //% shim=browserEvents::currentTime
    declare function currentTime(): number;
    //% shim=browserEvents::getYear
    declare function getHours(time: number): number;
    //% shim=browserEvents::getMinutes
    declare function getMinutes(time: number): number;
    //% shim=browserEvents::getSeconds
    declare function getSeconds(time: number): number;

    //% blockId="clock_create" block="create"
    //% blockSetVariable="clock"
    export function create(): Clock {
        return new Clock();
    }

    export class Clock {
         private _hours: number;
         private _minutes: number;
         private _seconds: number;

         private _image: Image;

         constructor() {
             this._hours = getHours(currentTime());
             this._minutes = getMinutes(currentTime());
             this._seconds = getSeconds(currentTime());

             this._image = image.create(screen.width, screen.height);
        
             this.createClock();
         }

         //% blockId="clock_set_time" block="$this(timer) %hour %minute %second"
        setTime?(hour: number, minute: number, second?: number) {
         this._hours = hour;
         this._minutes = minute;
         this._seconds = second;
        }

        /**
         * TODO: clock numbers not done yet
         */
        protected createClock() {
          this._image.drawTransparentImage(img`
              ................................................................................
              ................................................................................
              ................................................................................
              ................................................................................
              ................................................................................
              ................................................................................
              ..................................fffffffffffffff...............................
              ................................ff111111111111111ff.............................
              ..............................ff1111111111111111111ff...........................
              ............................ff11111111111111111111111ff.........................
              ..........................ff111111111111111111111111111ff.......................
              .........................f1111111111111111111111111111111f......................
              ........................f111111111111111111111111111111111f.....................
              .......................f11111111111111111111111111111111111f....................
              ......................f1111111111111111111111111111111111111f...................
              .....................f111111111111111111111111111111111111111f..................
              .....................f111111111111111111111111111111111111111f..................
              ....................f11111111111111111111111111111111111111111f.................
              ....................f11111111111111111111111111111111111111111f.................
              ...................f1111111111111111111111111111111111111111111f................
              ...................f1111111111111111111111111111111111111111111f................
              ..................f111111111111111111111111111111111111111111111f...............
              ..................f111111111111111111111111111111111111111111111f...............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f1111111111111111111111f111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              .................f11111111111111111111111111111111111111111111111f..............
              ..................f111111111111111111111111111111111111111111111f...............
              ..................f111111111111111111111111111111111111111111111f...............
              ...................f1111111111111111111111111111111111111111111f................
              ...................f1111111111111111111111111111111111111111111f................
              ....................f11111111111111111111111111111111111111111f.................
              ....................f11111111111111111111111111111111111111111f.................
              .....................f111111111111111111111111111111111111111f..................
              .....................f111111111111111111111111111111111111111f..................
              ......................f1111111111111111111111111111111111111f...................
              .......................f11111111111111111111111111111111111f....................
              ........................f111111111111111111111111111111111f.....................
              .........................f1111111111111111111111111111111f......................
              ..........................ff111111111111111111111111111ff.......................
              ............................ff11111111111111111111111ff.........................
              ..............................ff1111111111111111111ff...........................
              ................................ff111111111111111ff.............................
              ..................................fffffffffffffff...............................
              ................................................................................
              ................................................................................
              ................................................................................
              ................................................................................
              ................................................................................
          `, screen.width >> 2, screen.height >> 2);
          
          const clockSprite = sprites.create(this._image);

            game.onPaint(() => {
                this._seconds = getSeconds(currentTime())
                this._minutes = getMinutes(currentTime());
                this._hours = getHours(currentTime());

                const cx = this._image.width >> 1;
                const cy = this._image.height >> 1;

                const radius = Math.min(cx, cy) - 10; // length of the hand

                const secondsAngle = this._seconds * 6; // 360 / 60
                const minutesAngle = this._minutes * 6 + this._seconds * 0.1; // smooth minutes
                const hoursAngle = (this._hours % 12) * 30 + this._minutes * 0.5; // smooth hours

                // convert degrees to radians
                const sRad = secondsAngle * Math.PI / 180;
                const mRad = minutesAngle * Math.PI / 180;
                const hRad = hoursAngle * Math.PI / 180;

                // draw second hand
                screen.drawLine(
                    cx, cy,
                    cx + radius * Math.sin(sRad),
                    cy - radius * Math.cos(sRad),
                    1
                );

                // draw minute hand
                screen.drawLine(
                    cx, cy,
                    cx + radius * 0.8 * Math.sin(mRad),
                    cy - radius * 0.8 * Math.cos(mRad),
                    2
                );

                // draw hour hand
                screen.drawLine(
                    cx, cy,
                    cx + radius * 0.6 * Math.sin(hRad),
                    cy - radius * 0.6 * Math.cos(hRad),
                    3
                );
            });
        }
    }
}

// new countdown.Clock()

